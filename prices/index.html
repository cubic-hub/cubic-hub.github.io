<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cubic Hub â€” Prices</title>
  <link rel="icon" href="../favicon.png" type="image/png" />
  <link rel="stylesheet" href="../css/styles.css" />
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="brand">Cubic Hub</div>
    <nav class="nav">
      <a href="../index.html">Home</a>
      <a href="../prices/index.html" class="active">Prices</a>
      <a href="../craft/index.html">Craft</a>
      <a href="../contact/index.html">Contact</a>
    </nav>
  </header>

  <!-- Main -->
  <main class="container">
    <section class="card">
      <h1>Clothing Prices</h1>

      <!-- Search -->
      <div class="search-wrapper">
        <input type="text" id="search" class="search-bar" placeholder="ðŸ” Search item..." autocomplete="off" />
        <button id="clear-btn" class="clear-btn" title="Clear search" style="display:none;">&times;</button>
      </div>

      <!-- Sort -->
      <div class="field">
        <label for="sort">Sort items</label>
        <select id="sort" class="select">
          <option value="none">None</option>
          <option value="asc">Price: Lowest â†’ Highest</option>
          <option value="desc">Price: Highest â†’ Lowest</option>
          <option value="az">Alphabetical: A â†’ Z</option>
          <option value="za">Alphabetical: Z â†’ A</option>
        </select>
      </div>

      <!-- Results -->
      <div id="section-content" class="grid" tabindex="0"></div>
      <div id="no-results" class="no-results" style="display:none;">No items found.</div>

      <!-- Pagination -->
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <span>&copy; 2025 Cubic Hub</span>
  </footer>

  <!-- Modal -->
  <dialog id="item-modal" class="modal" aria-labelledby="modal-name" aria-describedby="modal-price">
    <article class="card modal-card" role="document">
      <h2 id="modal-name"></h2>
      <div id="modal-price" class="modal-price"></div>
      <div class="item-image">
        <img id="modal-image" src="" alt="Item image" onerror="this.src='images/default.png'"/>
      </div>
      <div class="modal-actions">
        <button id="close-modal" class="btn-secondary">Close</button>
      </div>
    </article>
  </dialog>

  <script>
    // Data holders
    let allPrices = [];
    let groupedSections = {};
    let currentSection = 1;
    let highlightedIndex = -1;

    // Section names mapping
    const sectionNames = {
      1: "Valentine's Day",
      2: "Summer & Bad Egg",
      3: "Fan",
      4: "Crhistmas",
      5: "Quest & Hats",
      6: "Hats",
      7: "Accessories & Wands"
    };

    // Elements
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clear-btn');
    const paginationEl = document.getElementById('pagination');
    const modal = document.getElementById('item-modal');

    // Load JSON
    async function loadPrices() {
      try {
        const res = await fetch('prices.json');
        allPrices = await res.json();
      } catch (err) {
        allPrices = [];
        console.error('Failed to load prices.json', err);
      }

      // Group by section
      groupedSections = {};
      allPrices.forEach(entry => {
        const s = entry.section || 1;
        if (!groupedSections[s]) groupedSections[s] = [];
        groupedSections[s].push(entry);
      });

      renderPagination();
      applyFilters();
    }

    // Render items list
    function renderSection(list) {
      const container = document.getElementById('section-content');
      const noResults = document.getElementById('no-results');
      container.innerHTML = '';
      highlightedIndex = -1;

      if (!list || list.length === 0) {
        noResults.style.display = 'block';
        return;
      } else {
        noResults.style.display = 'none';
      }

      list.forEach((entry, index) => {
        const card = document.createElement('article');
        card.className = 'card item-card';
        card.tabIndex = 0;
        card.dataset.index = index;

        const name = document.createElement('div');
        name.className = 'item-name';
        name.textContent = entry.item;

        const price = document.createElement('div');
        price.className = 'item-price';
        if (entry.min != null && entry.max != null && entry.min !== entry.max) {
          price.textContent = `${entry.min.toLocaleString()} - ${entry.max.toLocaleString()}c`;
        } else if (entry.min != null) {
          price.textContent = `${entry.min.toLocaleString()}c`;
        } else {
          price.textContent = 'â€”';
        }

        card.appendChild(name);
        card.appendChild(price);

        // Click opens modal
        card.addEventListener('click', () => openModal(entry));

        // Allow focusing card with keyboard and Enter to open
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') openModal(entry);
        });

        container.appendChild(card);
      });
    }

    // Apply search + sort + pagination visibility
    function applyFilters() {
      const term = searchInput.value.trim().toLowerCase();
      const sortOption = document.getElementById('sort').value;

      let filtered;

      if (term) {
        clearBtn.style.display = 'block';
        filtered = allPrices.filter(entry => entry.item.toLowerCase().includes(term));
        paginationEl.style.display = 'none';
      } else {
        clearBtn.style.display = 'none';
        filtered = groupedSections[currentSection] ? [...groupedSections[currentSection]] : [];
        paginationEl.style.display = 'flex';
      }

      // Sorting
      if (sortOption === 'asc') {
        filtered.sort((a, b) => (a.min || 0) - (b.min || 0));
      } else if (sortOption === 'desc') {
        filtered.sort((a, b) => (b.max || 0) - (a.max || 0));
      } else if (sortOption === 'az') {
        filtered.sort((a, b) => a.item.localeCompare(b.item));
      } else if (sortOption === 'za') {
        filtered.sort((a, b) => b.item.localeCompare(a.item));
      }

      renderSection(filtered);
    }

    // Pagination buttons
    function renderPagination() {
      paginationEl.innerHTML = '';
      const sectionNumbers = Object.keys(groupedSections).map(Number).sort((a, b) => a - b);
      if (sectionNumbers.length === 0) return;

      sectionNumbers.forEach(num => {
        const btn = document.createElement('button');
        btn.textContent = sectionNames[num] || `Section ${num}`;
        btn.className = (num === currentSection) ? 'btn-primary' : 'btn-secondary';
        btn.addEventListener('click', () => {
          currentSection = num;
          applyFilters();
          renderPagination();
        });
        paginationEl.appendChild(btn);
      });
    }

    // Modal open/close
    function openModal(entry) {
      document.getElementById('modal-name').textContent = entry.item;
      const priceEl = document.getElementById('modal-price');
      if (entry.min != null && entry.max != null && entry.min !== entry.max) {
        priceEl.textContent = `${entry.min.toLocaleString()} - ${entry.max.toLocaleString()}c`;
      } else if (entry.min != null) {
        priceEl.textContent = `${entry.min.toLocaleString()}c`;
      } else {
        priceEl.textContent = 'â€”';
      }

      // Use image path from JSON; fallback handled by onerror attribute
      document.getElementById('modal-image').src = entry.image || 'images/default.png';
      document.getElementById('modal-image').alt = entry.item;

      modal.showModal();
      // trigger CSS animation class
      modal.classList.add('show');
    }

    function closeModal() {
      modal.classList.remove('show');
      // wait for CSS fade-out then close
      setTimeout(() => {
        if (modal.open) modal.close();
      }, 300);
    }

    // Click outside to close
    modal.addEventListener('click', (e) => {
      const article = modal.querySelector('article');
      if (!article) return;
      const rect = article.getBoundingClientRect();
      const clickedInside =
        e.clientX >= rect.left &&
        e.clientX <= rect.right &&
        e.clientY >= rect.top &&
        e.clientY <= rect.bottom;
      if (!clickedInside) closeModal();
    });

    // Close button
    document.getElementById('close-modal').addEventListener('click', closeModal);

    // Clear button
    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      applyFilters();
      searchInput.focus();
    });

    // Live search
    searchInput.addEventListener('input', () => {
      applyFilters();
    });

    // Keyboard navigation inside search input
    searchInput.addEventListener('keydown', (e) => {
      const cards = document.querySelectorAll('#section-content .item-card');
      if (!cards.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (highlightedIndex < cards.length - 1) highlightedIndex++;
        updateHighlight(cards);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (highlightedIndex > 0) highlightedIndex--;
        updateHighlight(cards);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (highlightedIndex >= 0 && highlightedIndex < cards.length) {
          const selectedName = cards[highlightedIndex].querySelector('.item-name').textContent;
          const entry = allPrices.find(p => p.item === selectedName);
          if (entry) openModal(entry);
        }
      }
    });

    // Update highlight visuals
    function updateHighlight(cards) {
      cards.forEach(c => c.classList.remove('highlight'));
      if (highlightedIndex >= 0 && highlightedIndex < cards.length) {
        const el = cards[highlightedIndex];
        el.classList.add('highlight');
        el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+F or Cmd+F focuses search and prevents browser find
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
        e.preventDefault();
        searchInput.focus();
        return;
      }

      // Escape behavior: if modal open, close it; otherwise clear search
      if (e.key === 'Escape') {
        if (modal.open) {
          closeModal();
        } else {
          if (searchInput.value) {
            searchInput.value = '';
            applyFilters();
          }
        }
      }
    });

    // Sort change
    document.getElementById('sort').addEventListener('change', applyFilters);

    // Initialize
    loadPrices();
  </script>
</body>
</html>
